{% extends "shared/custom_base.html" %}
{% block style %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
{% endblock style %}
<!--begin::Wrapper-->
{% block content %}
<div class="app-wrapper flex-column flex-row-fluid" id="kt_app_wrapper">
  <!--begin::Main-->
  <div class="app-main flex-column flex-row-fluid" id="kt_app_main">
    <!--begin::Content wrapper-->
    <div class="d-flex flex-column flex-column-fluid">
      <!--begin::Content-->
      <div id="kt_app_content" class="app-content flex-column-fluid">
        <!--begin::Content container-->
        <div id="kt_app_content_container" class="app-container container-xxl">
          <!--begin::Layout-->
          <div class="d-flex flex-column flex-xl-row">
            <!--begin::Content-->
            <div class="d-flex flex-row-fluid me-xl-9 mb-10 mb-xl-0">
              <!--begin::Pos food-->
              <div class="card card-flush card-p-0 bg-transparent border-0">
                <!--begin::Body-->
                <div class="card-body">
                  <!--begin::Nav-->
                  <ul class="nav nav-pills d-flex justify-content-between nav-pills-custom gap-3 mb-6">
                    <!--begin::Item-->
                    <li class="nav-item mb-3 me-0">
                      <!--begin::Nav link-->
                      <a class="nav-link nav-link-border-solid btn btn-outline btn-flex btn-active-color-primary flex-column flex-stack pt-9 pb-7 page-bg show active"
                        data-bs-toggle="pill" href="#kt_pos_food_content_1" style="width: 138px; height: 180px">
                        <!--begin::Icon-->
                        <div class="nav-icon mb-3">
                          <!--begin::Food icon-->
                          <img src="{{ url_for('static', filename='assets/media/svg/food-icons/spaghetti.svg') }}" class="w-50px" alt="" />
                          <!--end::Food icon-->
                        </div>
                        <!--end::Icon-->
                        <!--begin::Info-->
                        <div class="">
                          <span class="text-gray-800 fw-bold fs-2 d-block">Lunch</span>
                          <span class="text-gray-500 fw-semibold fs-7">8 Options</span>
                        </div>
                        <!--end::Info-->
                      </a>
                      <!--end::Nav link-->
                    </li>
                    <!--end::Item-->
                  </ul>
                  <!--end::Nav-->
                  <!--begin::Tab Content-->
                  <div class="tab-content">
                    <!--begin::Tap pane-->
                    <div class="tab-pane fade show active" id="kt_pos_food_content_1">
                      <!--begin::Wrapper-->
                      <div class="d-flex flex-wrap d-grid gap-5 gap-xxl-9">
                        <!--begin::Card-->
                        {% for item in menu_items %}
                        <div class="card card-flush flex-row-fluid p-6 pb-5 mw-100">
                          <!--begin::Body-->
                          <div class="card-body text-center">
                            <!--begin::Food img-->
                            <img src="static/assets/media/stock/food/img-2.jpg"
                              class="rounded-3 mb-4 w-150px h-150px w-xxl-200px h-xxl-200px" alt="" />
                            <!--end::Food img-->
                            <!--begin::Info-->
                            <div class="mb-2">
                              <!--begin::Title-->
                              <div class="text-center">
                                <span
                                  class="fw-bold text-gray-800 cursor-pointer text-hover-primary fs-3 fs-xl-1" data-name="{{ item.name }}">{{ item.name }}</span>
                                <span class="text-gray-500 fw-semibold d-block fs-6 mt-n1">16 mins to cook</span>
                              </div>
                              <!--end::Title-->
                            </div>
                            <!--end::Info-->
                            <!--begin::Total-->
                            <span class="text-success text-end fw-bold fs-1" data-price="{{ item.price }}">${{ item.price }}</span>
                            <br>
                            <!--end::Total-->
                            <button type="submit" class="btn btn-primary mt-3 add-to-cart" data-item-id="{{ item.id }}" data-price="{{ item.price }}" data-name="{{ item.name }}" >加入購物車</button>
                          </div>
                          <!--end::Body-->
                        </div>
                        {% endfor %}
                        <!--end::Card-->
                      </div>
                      <!--end::Wrapper-->
                    </div>
                    <!--end::Tap pane-->
                  </div>
                  <!--end::Tab Content-->
                </div>
                <!--end: Card Body-->
              </div>
              <!--end::Pos food-->
            </div>
            <!--end::Content-->
            <!--begin::Sidebar-->
            <div class="flex-row-auto w-xl-450px">
              <!--begin::Pos order-->
              <div class="card card-flush bg-body" id="kt_pos_form">
                <!--begin::Header-->
                <div class="card-header px-5">
                  <h3 class="card-title fw-bold text-gray-800 fs-2qx">
                    Current Order
                  </h3>
                  <!--begin::Toolbar-->
                  <div class="card-toolbar">
                    <a href="#" id="clear-cart" class="btn btn-light-primary fs-4 fw-bold py-4">Clear All</a>
                  </div>
                  <!--end::Toolbar-->
                </div>
                <!--end::Header-->
                <!--begin::Body-->
                <div class="card-body pt-0">
                  <!--begin::Table container-->
                  <div class="table-responsive mb-8">
                    <!--begin::Table-->
                    <table class="table align-middle gs-0 gy-4 my-0">
                      <!--begin::Table head-->
                      <thead>
                        <tr>
                          <th class="min-w-175px"></th>
                          <th class="w-125px"></th>
                          <th class="w-60px"></th>
                        </tr>
                      </thead>
                      <!--end::Table head-->
                      <!--begin::Table body-->
                      <tbody id="cart-table-body">
                        <!-- js 插入資料 -->
                      </tbody>
                      <!--end::Table body-->
                    </table>
                    <!--end::Table-->
                  </div>
                  <!--end::Table container-->
                  <!--begin::Summary-->
                  <div class="d-flex flex-stack bg-success rounded-3 p-6 mb-11">
                    <!--begin::Content-->
                    <div class="fs-6 fw-bold text-white">
                      <span class="d-block lh-1 mb-2">Subtotal</span>
                      <span class="d-block mb-2">Discounts</span>
                      <span class="d-block fs-2qx lh-1">Total</span>
                    </div>
                    <!--end::Content-->
                    <!--begin::Content-->
                    <div class="fs-6 fw-bold text-white text-end">
                      <span class="d-block lh-1 mb-2" data-kt-pos-element="total">$100.50</span>
                      <span class="d-block mb-2" data-kt-pos-element="discount">-$8.00</span>
                      <span class="d-block fs-2qx lh-1" data-kt-pos-element="grant-total">$93.46</span>
                    </div>
                    <!--end::Content-->
                  </div>
                  <!--end::Summary-->
                  <!--begin::Payment Method-->
                  <div class="m-0">
                    <!--begin::Title-->
                    <h1 class="fw-bold text-gray-800 mb-5">Payment Method</h1>
                    <!--end::Title-->
                    <!--begin::Radio group-->
                    <div class="d-flex flex-equal gap-5 gap-xxl-9 px-0 mb-12" data-kt-buttons="true"
                      data-kt-buttons-target="[data-kt-button]">
                      <!--begin::Radio-->
                      <label
                        class="btn bg-light btn-color-gray-600 btn-active-text-gray-800 border border-3 border-gray-100 border-active-primary btn-active-light-primary w-100 px-4"
                        data-kt-button="true" for="cash">
                        <!--begin::Input-->
                        <input class="btn-check" type="radio" name="method" value="0" id="cash" />
                        <!--end::Input-->
                        <!--begin::Icon-->
                        <i class="ki-duotone ki-dollar fs-2hx mb-2 pe-0">
                          <span class="path1"></span>
                          <span class="path2"></span>
                          <span class="path3"></span>
                        </i>
                        <!--end::Icon-->
                        <!--begin::Title-->
                        <span class="fs-7 fw-bold d-block">Cash</span>
                        <!--end::Title-->
                      </label>
                      <!--end::Radio-->
                      <!--begin::Radio-->
                      <label
                        class="btn bg-light btn-color-gray-600 btn-active-text-gray-800 border border-3 border-gray-100 border-active-primary btn-active-light-primary w-100 px-4"
                        data-kt-button="true" for="card">
                        <!--begin::Input-->
                        <input class="btn-check" type="radio" name="method" value="1" id="card" />
                        <!--end::Input-->
                        <!--begin::Icon-->
                        <i class="ki-duotone ki-credit-cart fs-2hx mb-2 pe-0">
                          <span class="path1"></span>
                          <span class="path2"></span>
                        </i>
                        <!--end::Icon-->
                        <!--begin::Title-->
                        <span class="fs-7 fw-bold d-block">Card</span>
                        <!--end::Title-->
                      </label>
                      <!--end::Radio-->
                      <!--begin::Radio-->
                      <label
                        class="btn bg-light btn-color-gray-600 btn-active-text-gray-800 border border-3 border-gray-100 border-active-primary btn-active-light-primary w-100 px-4"
                        data-kt-button="true" for="linePay">
                        <!--begin::Input-->
                        <input class="btn-check" type="radio" name="method" value="2" id="linePay" />
                        <!--end::Input-->
                        <!--begin::Icon-->
                        <i class="ki-duotone ki-paypal fs-2hx mb-2 pe-0">
                          <span class="path1"></span>
                          <span class="path2"></span>
                        </i>
                        <!--end::Icon-->
                        <!--begin::Title-->
                        <span class="fs-7 fw-bold d-block">Line Pay</span>
                        <!--end::Title-->
                      </label>
                      <!--end::Radio-->
                    </div>
                    <!--end::Radio group-->
                    <!--begin::Actions-->
                    <button class="btn btn-primary fs-1 w-100 py-4" id="checkoutButton">
                      結帳
                    </button>
                    <!--end::Actions-->
                  </div>
                  <!--end::Payment Method-->
                </div>
                <!--end: Card Body-->
              </div>
              <!--end::Pos order-->
            </div>
            <!--end::Sidebar-->
          </div>
          <!--end::Layout-->
        </div>
        <!--end::Content container-->
      </div>
      <!--end::Content-->
    </div>
    <!--end::Content wrapper-->
    <!--begin::Footer-->
    <div id="kt_app_footer" class="app-footer">
      <!--begin::Footer container-->
      <div class="app-container container-fluid d-flex flex-column flex-md-row flex-center flex-md-stack py-3">
        <!--begin::Copyright-->
        <div class="text-gray-900 order-2 order-md-1">
          <span class="text-muted fw-semibold me-1">2024&copy;</span>
          <a href="https://keenthemes.com" target="_blank" class="text-gray-800 text-hover-primary">Keenthemes</a>
        </div>
        <!--end::Copyright-->
        <!--begin::Menu-->
        <ul class="menu menu-gray-600 menu-hover-primary fw-semibold order-1">
          <li class="menu-item">
            <a href="https://keenthemes.com" target="_blank" class="menu-link px-2">About</a>
          </li>
          <li class="menu-item">
            <a href="https://devs.keenthemes.com" target="_blank" class="menu-link px-2">Support</a>
          </li>
          <li class="menu-item">
            <a href="https://1.envato.market/EA4JP" target="_blank" class="menu-link px-2">Purchase</a>
          </li>
        </ul>
        <!--end::Menu-->
      </div>
      <!--end::Footer container-->
    </div>
    <!--end::Footer-->
  </div>
  <!--end:::Main-->
</div>
<!--end::Wrapper-->
<!--begin::Scrolltop-->
<div id="kt_scrolltop" class="scrolltop" data-kt-scrolltop="true">
  <i class="ki-duotone ki-arrow-up">
    <span class="path1"></span>
    <span class="path2"></span>
  </i>
</div>
{% endblock content %}
{% block script %}

{{ super() }}
<script>
  // cartItems 是一個全局變量
  let cartItems = JSON.parse(localStorage.getItem('cart')) || [];
  // 折扣金額
  let discountAmount = 0; 

  document.addEventListener('DOMContentLoaded', function () {
      // 註冊“加入購物車”按鈕的事件
      document.querySelectorAll('.add-to-cart').forEach(button => {
          button.addEventListener('click', addToCart);
      });

      // 註冊清除購物車的按鈕事件
      document.getElementById('clear-cart').addEventListener('click', clearCart);
      
      // 註冊結帳按鈕的事件
      document.getElementById("checkoutButton").addEventListener("click", checkLoginStatus);

      // 頁面加載時初始化購物車界面和摘要
      updateCartUI();
      loadCartSummary();
      updateCartSummary();
  
  
      // 頁面加載時顯示購物車內容
      updateCartUI();

      loadCartSummary(); // 加載購物車摘要
      updateCartSummary(); // 更新購物車摘要

  });

  // 加入購物車功能
  function addToCart() {
    const itemId = this.getAttribute('data-item-id');
    const itemName = this.getAttribute('data-name');
    const itemPrice = this.getAttribute('data-price');

    // 檢查商品是否已存在於購物車中
    const existingItem = cartItems.find(item => item.id === itemId);
    if (existingItem) {
        existingItem.quantity += 1; // 如果存在，則增加數量
    } else {
      const newItem = {
          id: itemId,
          name: itemName,
          price: itemPrice,
          quantity: 1 // 預設數量為 1
      };
      cartItems.push(newItem);
    }

    // 更新 localStorage 中的購物車數據
    localStorage.setItem('cart', JSON.stringify(cartItems));
    updateCartUI();
    updateCartSummary()
    displayFlashMessage('success', `${itemName} 已加入購物車！`);
  }

  // 顯示購物車中的商品
  function updateCartUI() {
    const cartTableBody = document.querySelector('#cart-table-body');

    cartTableBody.innerHTML = '';

    cartItems.forEach(item => {
      const newRow = document.createElement('tr');
      newRow.id = `cart-item-${item.id}`

      newRow.innerHTML = `
        <td class="pe-0">
            <div class="d-flex align-items-center">
                <img src="static/assets/media/stock/food/img-2.jpg" class="w-50px h-50px rounded-3 me-3" alt="" />
                <span class="fw-bold text-gray-800 cursor-pointer text-hover-primary fs-6 me-1">${item.name}</span>
            </div>
        </td>
        <td class="pe-0">
            <div class="position-relative d-flex align-items-center">
                <button type="button" class="btn btn-icon btn-sm btn-light btn-icon-gray-500" onclick="changeQuantity('${item.id}', -1)">-</button>
                <span class="quantity">${item.quantity}</span>
                <button type="button" class="btn btn-icon btn-sm btn-light btn-icon-gray-500" onclick="changeQuantity('${item.id}', 1)">+</button>
            </div>
        </td>
        <td class="text-end">
            <span class="total-price fw-bold text-primary fs-2">$${(item.price * item.quantity).toFixed(2)}</span>
        </td>
    `;
    cartTableBody.appendChild(newRow);
    });
  }

  // 修改數量並更新購物車
  window.changeQuantity = function (itemId, change) {
    const item = cartItems.find(item => item.id === itemId);
    if (item) {
        item.quantity += change;
        if (item.quantity < 1) {
          cartItems = cartItems.filter(item => item.id !== itemId); // 移除數量小於1的商品
        }
    }
    localStorage.setItem('cart', JSON.stringify(cartItems));
    updateCartUI();
    updateCartSummary();
}

  // 計算並更新購物車摘要
  function updateCartSummary() {
      let subtotal = 0;

      // 計算小計
      cartItems.forEach(item => {
          subtotal += item.price * item.quantity;
      });

      // 計算稅和總計
      const taxRate = 0.12; // 12% 稅率
      const total = subtotal - discountAmount;

      // 更新 UI 中的摘要信息
      document.querySelector('[data-kt-pos-element="total"]').textContent = `$${subtotal.toFixed(2)}`;
      document.querySelector('[data-kt-pos-element="discount"]').textContent = `-$${discountAmount.toFixed(2)}`;
      document.querySelector('[data-kt-pos-element="grant-total"]').textContent = `$${total.toFixed(2)}`;

      // 將總計信息存儲到 localStorage
      const summary = {
          subtotal: subtotal,
          discount: discountAmount,
          total: total,
      };
      localStorage.setItem('cartSummary', JSON.stringify(summary));
  }

  // 從 localStorage 恢復信息的函數
  function loadCartSummary() {
      const summary = JSON.parse(localStorage.getItem('cartSummary'));
      if (summary) {
          document.querySelector('[data-kt-pos-element="total"]').textContent = `$${summary.subtotal.toFixed(2)}`;
          document.querySelector('[data-kt-pos-element="discount"]').textContent = `-$${summary.discount.toFixed(2)}`;
          document.querySelector('[data-kt-pos-element="grant-total"]').textContent = `$${summary.total.toFixed(2)}`;
      }
  }

  // 清除購物車
  function clearCart(e) {
    e.preventDefault(); // 阻止默認的超鏈接行為
          
      // 清空購物車陣列
      cartItems = [];
      
      // 清空 localStorage 中的購物車數據
      localStorage.removeItem('cart');
      
      // 更新 UI 和購物車摘要
      updateCartUI();
      updateCartSummary();
      
      displayFlashMessage('info', '購物車已清空！');
  }

  // 檢查登入狀態
  function checkLoginStatus() {
      fetch("/check-login-status", {
          method: 'GET', 
          headers: {
              'Content-Type': 'application/json'
          },
      })
      .then(response => {
          if (response.redirected) {
              // 若未登入，會重定向到登入頁面
              window.location.href = response.url;
          } else {
              response.json().then(data => {
                  if (data.isLoggedIn) {
                      // 已登入，用戶可以繼續結帳流程
                      handleCheckout();
                  }
              });
          }
      })
      .catch(error => console.error("Error:", error));
  }

  // 處理結帳邏輯的函數
  function handleCheckout() {
    const radioButtons = document.querySelectorAll('input[name="method"]');

    // 为每个 radio button 添加 click 事件监听器
    radioButtons.forEach(radio => {
        radio.addEventListener('click', () => {
            // 清除所有 label 的 active 类
            const labels = document.querySelectorAll('label');

            labels.forEach(label => {
                // 移除 active 类
                label.classList.remove('active');
            });

            // 添加 active 类到当前被选中的 radio button 的 label
            const correspondingLabel = document.querySelector(`label[for="${radio.id}"]`);
            if (correspondingLabel) {
                correspondingLabel.classList.add('active');
            }
        });
    });


      const selectedMethod = document.querySelector('input[name="method"]:checked');

      if (selectedMethod) {
        if (selectedMethod.value === '2') {
          processLinePay();
        }
      } else {          
          displayFlashMessage('danger', '未選擇結帳方式');
      }
  }

  // 連結 line pay
  function processLinePay() {
      // 发起 AJAX 请求到后端 Line Pay 连接
      fetch("/linepay/request", {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
          },
          body: JSON.stringify({ cart: cartItems })
      })
      .then(response => response.json())
      .then(data => {
          // 在这里处理成功响应
          console.log("Line Pay Response:", data);
          // 可以重定向用户到 Line Pay 页面，假设 `data` 中有一个 `paymentUrl`

          if (data.info && data.info.paymentUrl) {
              // 根据需要选择使用的 URL
              const paymentUrl = data.info.paymentUrl.web; // 选择 app 或 web URL

              console.log("Redirecting to:", paymentUrl); // 打印将要重定向的 URL
              window.location.href = paymentUrl; // 重定向到支付页面
          } else {
              console.error("没有找到支付链接");
          }
      })
      .catch(error => {
          console.error("Error:", error);
          // 可以在这里显示错误信息给用户
      });
  }

 
</script>
  
{% endblock script %}